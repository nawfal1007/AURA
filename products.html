<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Artifact Detail | AURA APPAREL</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        aura: {
                            base: '#F9F7F2',    /* "Rice Paper" Off-White */
                            dark: '#15302a',    /* "Borneo" Deep Green */
                            charcoal: '#2D2D2D',
                            accent: '#C5A065',  /* "Rattan" Gold */
                            sand: '#E6E2DD',
                            terra: '#B08E77',
                            error: '#9B2C2C',
                            success: '#2F855A'
                        }
                    },
                    fontFamily: {
                        sans: ['Lato', 'sans-serif'],
                        serif: ['Playfair Display', 'serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.8s ease-out forwards',
                        'slide-up': 'slideUp 0.8s ease-out forwards',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>

    <style>
        [x-cloak] { display: none !important; }
        
        /* Glass Navigation */
        .glass-nav {
            background: rgba(249, 247, 242, 0.95);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(21, 48, 42, 0.05);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #15302a; border-radius: 3px; }
        ::-webkit-scrollbar-track { background: #F9F7F2; }

        /* Loader */
        .loader {
            width: 48px; height: 48px;
            border: 3px solid #15302a;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>

<body class="bg-aura-base text-aura-charcoal antialiased min-h-screen flex flex-col" x-data="productPageApp()">

    <div class="fixed top-24 right-5 z-50 flex flex-col gap-2 pointer-events-none">
        <template x-for="toast in toasts" :key="toast.id">
            <div x-show="toast.visible" 
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 translate-x-8"
                 x-transition:enter-end="opacity-100 translate-x-0"
                 x-transition:leave="transition ease-in duration-300"
                 x-transition:leave-start="opacity-100 translate-x-0"
                 x-transition:leave-end="opacity-0 translate-x-8"
                 class="bg-aura-dark text-white px-6 py-4 rounded shadow-2xl flex items-center gap-4 min-w-[300px] pointer-events-auto border-l-4"
                 :class="toast.type === 'error' ? 'border-aura-error' : 'border-aura-accent'">
                <i class="ph-fill text-xl" :class="toast.type === 'error' ? 'ph-warning-circle' : 'ph-check-circle'"></i>
                <div>
                    <h4 class="font-bold text-xs uppercase tracking-wider" x-text="toast.title"></h4>
                    <p class="text-xs text-white/80" x-text="toast.message"></p>
                </div>
            </div>
        </template>
    </div>

    <header class="fixed top-0 w-full z-40 glass-nav text-aura-dark transition-all duration-500">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            
            <div class="flex items-center gap-4 w-1/3">
                <a href="catalog.html" class="flex items-center gap-2 hover:text-aura-accent transition group text-[10px] font-bold uppercase tracking-widest">
                    <i class="ph ph-arrow-left text-lg group-hover:-translate-x-1 transition-transform"></i>
                    <span class="hidden sm:inline">Catalog</span>
                </a>
            </div>

            <div class="w-1/3 text-center">
                <a href="index.html">
                    <h1 class="text-2xl font-serif font-bold tracking-[0.2em] uppercase">Aura<span class="text-aura-accent">.</span></h1>
                </a>
            </div>

            <div class="flex items-center justify-end gap-6 w-1/3">
                <template x-if="isAdmin">
                    <a href="admin.html" class="hidden md:flex items-center gap-2 bg-aura-dark text-aura-accent px-3 py-1.5 rounded-full text-[9px] font-bold uppercase tracking-widest shadow-sm hover:bg-aura-accent hover:text-aura-dark transition">
                        <i class="ph-fill ph-crown"></i> Admin
                    </a>
                </template>

                <a href="loginpage.html" x-show="!session" class="hover:text-aura-accent transition"><i class="ph ph-user text-xl"></i></a>
                
                <button @click="cartOpen = true" class="relative hover:text-aura-accent transition p-1">
                    <i class="ph ph-tote text-xl"></i>
                    <span x-show="cartCount > 0" x-cloak class="absolute -top-1 -right-1 bg-aura-accent text-white text-[10px] w-4 h-4 rounded-full flex items-center justify-center font-bold shadow-sm" x-text="cartCount"></span>
                </button>
            </div>
        </div>
    </header>

    <main class="flex-1 pt-32 pb-20 container mx-auto px-6">
        
        <div x-show="loading" class="flex flex-col items-center justify-center py-40 min-h-[60vh]">
            <span class="loader mb-6"></span>
            <p class="text-xs font-bold uppercase tracking-[0.3em] text-aura-dark animate-pulse">Retrieving Artifact...</p>
        </div>

        <div x-show="!loading && !product" class="text-center py-40" x-cloak>
            <i class="ph ph-ghost text-6xl text-gray-300 mb-4"></i>
            <h2 class="text-2xl font-serif text-aura-dark">Artifact Not Found</h2>
            <p class="text-gray-500 mt-2 mb-8">This item may have been archived or removed.</p>
            <a href="catalog.html" class="inline-block bg-aura-dark text-white px-8 py-3 rounded text-xs font-bold uppercase tracking-widest hover:bg-aura-accent transition">Return to Catalog</a>
        </div>

        <div x-show="!loading && product" class="grid grid-cols-1 lg:grid-cols-2 gap-12 lg:gap-24 items-start" x-cloak>
            
            <div class="relative group animate-fade-in">
                <div class="aspect-[3/4] bg-gray-100 overflow-hidden rounded-sm relative shadow-xl">
                    <img :src="product?.image" class="w-full h-full object-cover transition-transform duration-[3s] group-hover:scale-105">
                    
                    <template x-if="isAdmin">
                        <div class="absolute top-4 right-4 z-20">
                            <a href="admin.html" 
                               class="flex items-center gap-2 bg-aura-accent text-aura-dark px-4 py-2 rounded shadow-lg hover:bg-white transition transform hover:scale-105">
                                <i class="ph-fill ph-pencil-simple"></i>
                                <span class="text-[10px] font-bold uppercase tracking-widest">Edit Artifact</span>
                            </a>
                        </div>
                    </template>

                    <div class="absolute bottom-6 left-6 flex flex-col gap-2">
                        <span x-show="product?.is_new" class="bg-aura-dark text-white text-[10px] font-bold uppercase tracking-widest px-4 py-2 w-max shadow-lg">New Arrival</span>
                        <span x-show="product?.badge" class="bg-white/90 backdrop-blur text-aura-dark text-[10px] font-bold uppercase tracking-widest px-4 py-2 w-max shadow-lg border border-white/20" x-text="product?.badge"></span>
                    </div>
                </div>
            </div>

            <div class="pt-4 lg:pt-12 space-y-10 animate-slide-up">
                
                <div class="space-y-4 border-b border-aura-dark/10 pb-10">
                    <div class="flex items-center justify-between">
                        <p class="text-aura-accent font-bold uppercase tracking-[0.2em] text-xs" x-text="product?.category"></p>
                        
                        <button @click="copyLink" class="text-gray-400 hover:text-aura-dark transition" title="Copy Link">
                            <i class="ph ph-share-network text-xl"></i>
                        </button>
                    </div>
                    
                    <h1 class="text-4xl md:text-5xl font-serif text-aura-dark leading-tight" x-text="product?.name"></h1>
                    
                    <p class="text-2xl font-bold text-aura-dark font-mono" x-text="formatMoney(product?.price)"></p>
                </div>

                <div class="prose prose-sm text-gray-500 leading-relaxed">
                    <p x-text="product?.description || 'No description provided for this artifact.'"></p>
                    <ul class="mt-4 space-y-2 text-xs uppercase tracking-widest text-aura-dark/60 font-bold list-disc pl-4">
                        <li>Sustainable Origin</li>
                        <li>Artisan Crafted in Java</li>
                        <li>100% Biodegradable Packaging</li>
                    </ul>
                </div>

                <div class="space-y-8 pt-4">
                    
                    <div>
                        <div class="flex justify-between items-center mb-3">
                            <label class="text-[10px] font-bold uppercase tracking-widest text-aura-dark">Select Size</label>
                            <button class="text-[10px] text-gray-400 underline hover:text-aura-dark">Size Guide</button>
                        </div>
                        <div class="grid grid-cols-3 gap-4">
                            <template x-for="size in ['S', 'M', 'L']">
                                <button @click="selectedSize = size" 
                                        class="py-4 border text-sm font-bold transition-all duration-300 relative overflow-hidden group"
                                        :class="selectedSize === size ? 'border-aura-dark bg-aura-dark text-white' : 'border-gray-200 text-gray-600 hover:border-aura-dark'">
                                    <span class="relative z-10" x-text="size"></span>
                                </button>
                            </template>
                        </div>
                        <p x-show="showSizeError" class="text-aura-error text-[10px] font-bold uppercase mt-2 animate-pulse">Please select a size.</p>
                    </div>

                    <div>
                        <label class="text-[10px] font-bold uppercase tracking-widest text-aura-dark mb-3 block">Quantity</label>
                        <div class="flex items-center w-32 border border-gray-200 h-12">
                            <button @click="quantity > 1 ? quantity-- : null" class="w-10 h-full hover:bg-gray-50 flex items-center justify-center text-gray-500 transition"><i class="ph ph-minus"></i></button>
                            <span class="flex-1 text-center font-bold text-aura-dark" x-text="quantity"></span>
                            <button @click="quantity++" class="w-10 h-full hover:bg-gray-50 flex items-center justify-center text-gray-500 transition"><i class="ph ph-plus"></i></button>
                        </div>
                    </div>

                    <div class="pt-4 border-t border-aura-dark/10">
                        <button @click="addToCart" 
                                :disabled="adding"
                                class="w-full bg-aura-dark text-white py-5 text-xs font-bold uppercase tracking-[0.3em] hover:bg-aura-accent hover:text-aura-dark transition-all duration-500 shadow-xl flex items-center justify-center gap-3 group relative overflow-hidden">
                            <span class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-500"></span>
                            <span x-show="!adding" class="relative z-10 flex items-center gap-2">
                                Add to Archive <i class="ph ph-arrow-right group-hover:translate-x-1 transition-transform"></i>
                            </span>
                            <span x-show="adding" class="relative z-10 flex items-center gap-2">
                                <i class="ph ph-spinner animate-spin text-lg"></i> Processing
                            </span>
                        </button>
                        <p class="text-center text-[10px] text-gray-400 mt-4 uppercase tracking-widest">
                            <i class="ph-fill ph-shield-check text-aura-success"></i> Secure Transaction â€¢ 7-Day Guarantee
                        </p>
                    </div>

                </div>
            </div>
        </div>
    </main>

    <div class="relative z-50" aria-labelledby="slide-over-title" role="dialog" aria-modal="true" x-show="cartOpen" x-cloak>
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm transition-opacity" 
             x-show="cartOpen"
             x-transition:enter="ease-in-out duration-500"
             x-transition:enter-start="opacity-0"
             x-transition:enter-end="opacity-100"
             x-transition:leave="ease-in-out duration-500"
             x-transition:leave-start="opacity-100"
             x-transition:leave-end="opacity-0"
             @click="cartOpen = false"></div>

        <div class="fixed inset-0 overflow-hidden">
            <div class="absolute inset-0 overflow-hidden">
                <div class="pointer-events-none fixed inset-y-0 right-0 flex max-w-full pl-0 sm:pl-10">
                    <div class="pointer-events-auto w-screen max-w-md transform transition ease-in-out duration-500"
                         x-show="cartOpen"
                         x-transition:enter="translate-x-full"
                         x-transition:enter-end="translate-x-0"
                         x-transition:leave="translate-x-0"
                         x-transition:leave-end="translate-x-full">
                        
                        <div class="flex h-full flex-col bg-white shadow-2xl">
                            <div class="flex items-start justify-between px-4 py-6 sm:px-6 border-b border-gray-100 bg-aura-base">
                                <h2 class="text-xl font-serif text-aura-dark font-bold">Shopping Bag</h2>
                                <button type="button" class="text-gray-400 hover:text-aura-error transition p-2" @click="cartOpen = false"><i class="ph ph-x text-2xl"></i></button>
                            </div>

                            <div class="flex-1 overflow-y-auto px-4 py-6 sm:px-6 relative">
                                <ul role="list" class="-my-6 divide-y divide-gray-100">
                                    <template x-for="(item, index) in cart" :key="index">
                                        <li class="flex py-6">
                                            <div class="h-24 w-20 flex-shrink-0 overflow-hidden border border-gray-200 rounded-sm">
                                                <img :src="item.image" class="h-full w-full object-cover object-center">
                                            </div>
                                            <div class="ml-4 flex flex-1 flex-col">
                                                <div>
                                                    <div class="flex justify-between text-base font-medium text-aura-dark">
                                                        <h3 x-text="item.name" class="font-serif pr-4"></h3>
                                                        <p class="whitespace-nowrap" x-text="formatMoney(item.price)"></p>
                                                    </div>
                                                    <p class="mt-1 text-xs text-aura-dark font-bold">Size: <span x-text="item.size" class="text-aura-accent"></span></p>
                                                </div>
                                                <div class="flex flex-1 items-end justify-between text-sm">
                                                    <p class="text-gray-500 text-xs">Qty <span x-text="item.quantity"></span></p>
                                                    <button type="button" @click="removeFromCart(index, item)" class="text-aura-error text-[10px] font-bold uppercase hover:text-red-700">Remove</button>
                                                </div>
                                            </div>
                                        </li>
                                    </template>
                                </ul>
                            </div>

                            <div class="border-t border-gray-100 px-4 py-6 sm:px-6 bg-aura-base/30">
                                <div class="flex justify-between text-base font-medium text-aura-dark mb-4">
                                    <p class="font-serif font-bold">Subtotal</p>
                                    <p class="font-bold" x-text="formatMoney(cartTotal)"></p>
                                </div>
                                <div class="mt-6">
                                    <a href="checkout.html" class="flex items-center justify-center bg-aura-dark px-6 py-4 text-white hover:bg-aura-accent transition uppercase tracking-widest text-xs font-bold rounded-sm shadow-lg">Checkout</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-[#0e231f] text-white pt-24 pb-12 border-t border-white/5 mt-auto">
        <div class="container mx-auto px-6">
            <div class="flex flex-col md:flex-row justify-between items-center text-[10px] text-white/30 uppercase tracking-widest">
                <p>&copy; 2026 Aura Apparel Indonesia.</p>
                <div class="flex gap-8 mt-4 md:mt-0">
                    <a href="index.html" class="hover:text-white transition">Back to Home</a>
                    <a href="#" class="hover:text-white transition">Support</a>
                </div>
            </div>
        </div>
    </footer>

    <script>
        function productPageApp() {
            return {
                /* SUPABASE */
                supabase: null,
                session: null,
                
                /* STATE */
                isAdmin: false,
                loading: true,
                adding: false,
                cartOpen: false,
                
                /* PRODUCT DATA */
                productId: null,
                product: null,
                
                /* USER SELECTIONS */
                selectedSize: null,
                quantity: 1,
                showSizeError: false,

                /* GLOBAL DATA */
                cart: [],
                toasts: [],
                
                /* CONFIG */
                ADMIN_EMAIL: 'dashwebtr3@gmail.com',

                get cartTotal() { return this.cart.reduce((t, i) => t + (i.price * i.quantity), 0); },
                get cartCount() { return this.cart.reduce((t, i) => t + i.quantity, 0); },

                init() {
                    // 1. Get ID from URL
                    const urlParams = new URLSearchParams(window.location.search);
                    this.productId = urlParams.get('id');

                    if (!this.productId) {
                        window.location.href = 'catalog.html';
                        return;
                    }

                    // 2. Init Supabase
                    this.initSupabase();
                },

                async initSupabase() {
                    const sbUrl = 'https://xenosyklkpisszqwibdw.supabase.co';
                    const sbKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhlbm9zeWtsa3Bpc3N6cXdpYmR3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4NTkxNzcsImV4cCI6MjA4NjQzNTE3N30.A_WVC9GRa7USe2DPbzVUWw3TuBHnyImVqBZnzuPJbMw';
                    
                    if (typeof supabase !== 'undefined') {
                        this.supabase = supabase.createClient(sbUrl, sbKey);
                        
                        await Promise.all([
                            this.fetchProductDetails(),
                            this.checkSession()
                        ]);
                    }
                },

                async checkSession() {
                    const { data: { session } } = await this.supabase.auth.getSession();
                    this.session = session;
                    
                    // ADMIN CHECK
                    this.isAdmin = session && session.user.email === this.ADMIN_EMAIL;

                    if (session) {
                        await this.fetchCloudCart();
                    } else {
                        this.loadLocalCart();
                    }
                },

                async fetchProductDetails() {
                    this.loading = true;
                    try {
                        const { data, error } = await this.supabase
                            .from('products')
                            .select('*')
                            .eq('id', this.productId)
                            .single();
                        
                        if (error) throw error;
                        this.product = data;
                        document.title = `${data.name} | AURA APPAREL`;
                    } catch (e) {
                        console.error('Product Error:', e);
                        this.product = null;
                    } finally {
                        this.loading = false;
                    }
                },

                async addToCart() {
                    if (!this.selectedSize) {
                        this.showSizeError = true;
                        setTimeout(() => this.showSizeError = false, 2000);
                        return;
                    }

                    this.adding = true;
                    
                    try {
                        if (this.session) {
                            // CLOUD ADD
                            const { error } = await this.supabase
                                .from('cart_items')
                                .upsert({
                                    user_id: this.session.user.id,
                                    product_id: this.product.id,
                                    size: this.selectedSize,
                                    quantity: this.quantity // Note: Logic simplified for upsert, ideally check existing qty first
                                }, { onConflict: 'user_id, product_id, size' });
                            
                            if (error) throw error;
                            await this.fetchCloudCart();
                        } else {
                            // LOCAL ADD
                            const item = { ...this.product, size: this.selectedSize, quantity: this.quantity };
                            const existing = this.cart.find(i => i.id === item.id && i.size === item.size);
                            if (existing) existing.quantity += this.quantity;
                            else this.cart.push(item);
                            this.saveLocalCart();
                        }
                        
                        this.showToast('Added to Archive', `${this.product.name} (${this.selectedSize})`);
                        this.cartOpen = true; // Open drawer
                        this.quantity = 1; // Reset qty
                    } catch (e) {
                        console.error(e);
                        this.showToast('Error', 'Could not add item', 'error');
                    } finally {
                        this.adding = false;
                    }
                },

                // CART UTILS (Duplicate from Catalog for consistency)
                saveLocalCart() { localStorage.setItem('aura_cart_guest', JSON.stringify(this.cart)); },
                loadLocalCart() { const stored = localStorage.getItem('aura_cart_guest'); if (stored) this.cart = JSON.parse(stored); },
                
                async fetchCloudCart() {
                    try {
                        const { data } = await this.supabase.from('cart_items').select('*');
                        // Merge with product details manually if needed, or assume data structure matches
                        // For this page, we just need basic cart info.
                        // Ideally we join tables, but for simplicity we'll just map roughly or fetch products again if cart items are missing details
                        // For now, let's assume we just want the count.
                        // To be perfect, let's fetch full cart details:
                         const { data: cartData } = await this.supabase.from('cart_items').select('*');
                         // We need product info for each cart item
                         const productIds = cartData.map(c => c.product_id);
                         const { data: products } = await this.supabase.from('products').select('*').in('id', productIds);
                         
                         this.cart = cartData.map(c => {
                             const p = products.find(prod => prod.id === c.product_id);
                             return { ...p, size: c.size, quantity: c.quantity };
                         });

                    } catch (e) { console.error(e); }
                },

                async removeFromCart(index, item) {
                    if (this.session) {
                         await this.supabase.from('cart_items').delete().match({ user_id: this.session.user.id, product_id: item.id, size: item.size });
                         this.fetchCloudCart();
                    } else {
                        this.cart.splice(index, 1);
                        this.saveLocalCart();
                    }
                },

                copyLink() {
                    navigator.clipboard.writeText(window.location.href);
                    this.showToast('Link Copied', 'Share this artifact.');
                },

                showToast(title, message, type = 'success') {
                    const id = Date.now();
                    this.toasts.push({ id, title, message, type, visible: true });
                    setTimeout(() => {
                        this.toasts = this.toasts.filter(t => t.id !== id);
                    }, 3000);
                },

                formatMoney(amount) {
                    if (!amount) return 'Rp 0';
                    return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumSignificantDigits: 9 }).format(amount);
                }
            }
        }
    </script>
</body>
</html>
